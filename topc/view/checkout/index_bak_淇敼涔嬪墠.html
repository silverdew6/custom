<style type="text/css">
.order-confirm-item-bd .item_store_head{line-height: 30px; font-size: 1.2em; text-indent: 2em;border-bottom: 1px solid #DDD; color: #8ab660; background: #efefef;}

</style>
<div id="main" class="main">
	<div class="wrap-lg">
		<div class="section">
			<div class="crumbs">
				<em class="color1">您当前位置</em>
				<span>>&nbsp;&nbsp;<a href="#">确认订单</a> </span>
        <span><a href="<{url action=topc_ctl_cart@index}>" class="order-confirm-item-right">&lt;&nbsp;返回修改购物车</a></span>
			</div>
		</div>
		<form action="<{url action=topc_ctl_trade@create}>" method="post">
			<input type="hidden" name="checkout" value="1">
			<input type="hidden" name="mode" value="<{$mode}>">
			<input type="hidden" name="md5_cart_info" value="<{$md5_cart_info}>">
			<div class="section">
				<div class="cart order-confirm ">
					<div class="order-confirm-title">填写并确认订单信息</div>
					<div class="order-confirm-item" id="checkout_address">
						<div class="order-confirm-item-hd">
							<em>收货信息(因涉及国家监管部门规定，需要对收货信息实名备案，本网站不会保留相关个人信息，请放心填写)</em>
							<!-- <a href="javascript:void(0);" class="step1-open">修改</a> -->
							<a href="<{url action=topc_ctl_member@address}>" target="_blank" class="order-confirm-item-right">管理收货地址</a>
						</div>
						<div class="order-confirm-item-bd" id="address_edit">
							<div class="step1-update" style="display:none;"></div>
								<{include file="topc/checkout/address/addr_list.html"}>
								<!-- <ul class="order-confirm-address addr-more-info">
								  <li class="form-row">
								    <input type="radio" name="addr" id="for_newaddr" class="action-edit-address" value="-1">
								    <label for="for_newaddr">使用新地址</label>
								  </li>
								  <li class="addr-more">
								    <span><i class="icon icon-chevron-down" data-icon="\2844" data-value="0"></i>&nbsp;<span name="txt-all">显示所有</span></span>
								  </li>
								</ul> -->
						</div>
					</div>
					<!-- 身份证 -->
							
					<div class="order-confirm-item order-verify-paytype" id="text_buycard">
					<input type="hidden" id="buycard_val" name="buycard_val" value="<{$buycard}>"/>
					<{if $buycard==''}>
						<div class="order-confirm-item-hd" style="height: 10px;line-height: 10px;padding: 0 10px;"><em>因涉及国家监管部门规定，需要对购买人信息实名备案，本网站不会保留相关个人信息，请放心填写</em>
						</div>
						<div >
						<br/>
							&nbsp;&nbsp;&nbsp;身份证号:&nbsp;<input type="text" style="width:200px;height:16px;" name="buycard"  id="buycard"value=""/><button type="button" id='button_usercard'><span><span>保存</span></span></button>
						</div>
						<{/if}>
					</div>



					<!-- 支付及配送方式 -->
					<div class="order-confirm-item order-verify-paytype">
						<div class="order-confirm-item-hd" style="height: 10px;line-height: 10px;padding: 0 10px;"><em>支付及配送方式</em>
							<!-- <a href="#" class="step2-open">修改</a> -->
						</div>
						<div class="order-confirm-item-bd">
							<div class="step2-update" style="display:none;"></div>
							<ul class="clearfix paytype-item">
								<li class="form-row">
									<span class="">
										<input type="radio" name="payment_type" id="yl" checked value="online">
										<label for="yl">在线支付</label>
									</span>
								</li>
				                <{if $isSelfShop && $ifOpenOffline == "true"}>
				                <li class="form-row">
				                  <span class="">
				                    <input type="radio" name="payment_type" id="zub" value="offline">
				                    <label for="zub">货到付款</label>
				                  </span>
				                </li>
				                <{/if}>
							</ul>
						</div>
					</div>

          <!-- 商品循环体 -->
          <!-- 确认商品清单 -->
          <{foreach from=$cartInfo.resultCartData key=shop_id item=cart}>
          <div class="order-confirm-item order-verify-gooditem">
            <div class="order-confirm-item-hd" style="height: 10px;line-height: 10px;padding: 0 10px;"><em>确认商品清单</em></div>
            <div class="order-confirm-item-bd">
              <div class="item-bd item-border clearfix">
              	<div class="item_store_head" style="">
              		[店铺]&nbsp;&nbsp;&nbsp;<a href="<{url action=topc_ctl_shopcenter@index shop_id=$shop_id}>"><font color="#3849C5" size="2"><b><{$cart.shop_name}></b></font></a>
              	</div>
                <div class="gooditem-left">
                  <div class="left-infos">
                    <ul>
                      <li class="form-row">配送类型</li>
                      <li class="form-row">
                        <span class="">
                          <input type="radio" name="distribution[<{$shop_id}>][type]" data-name="distribution[<{$shop_id}>]" id="kdps_<{$shop_id}>" checked value="1" data-shopid="<{$shop_id}>" data-weight="<{$cart.cartCount.total_weight}>">
                          <label for="kdps_<{$shop_id}>">快递配送</label>
                        </span>&nbsp;&nbsp;&nbsp;
                        <{if $cart.shop_type === "self" && $isSelfShop && $ifOpenZiti == "true"}>
                        <span class="">
                          <input type="radio" name="distribution[<{$shop_id}>][type]" data-name="smzq[<{$shop_id}>]" id="smzq_<{$shop_id}>" data-shopid="<{$shop_id}>" value="0">
                          <label for="smzq_<{$shop_id}>">上门自取</label>
                        </span>
                        <{/if}>
                      </li>
                      <li class="form-row line-bottom clearfix" name="kdps_<{$shop_id}>">
                        <span class="row-title">配送方式：
                          <select name="shipping[<{$shop_id}>][template_id]" data-shopid="<{$shop_id}>">
                          </select>
                        </span>
                      </li>
                      <li class="form-row line-bottom clearfix" name="smzq_<{$shop_id}>" style="display:none;">
                        <input type="hidden" name="ziti[<{$shop_id}>][ziti_id]" class="ziti-id" value="">
                        <span class="row-title">自取地点：<span class="ziti-addr" data-name="ziti-addr[<{$shop_id}>]">请选择自取地点</span></span><a href="javascript:void(0);" class="sp-set takegoods-set" data-shopid="<{$shop_id}>">设置</a>
                      </li>
                    </ul>
                  </div>
                </div>
                <div class="gooditem-right" style="padding: 0px;width:68%;">
                  <table class="item-table table-checkout" style="padding: 0px;">
                    <colgroup>
                      <col class="table-col-1">
                      <col width="35%">
                      <col class="table-col-3">
                      <col class="table-col-4">
                      <col class="table-col-5">
					  <col class="table-col-6">
					  <col class="table-col-7">
					  <!--<col class="table-col-8">-->
                    </colgroup>
                    <thead>
                      <tr>
                      	<td colspan="9" style="border-bottom: 1px solid #DDD;"><{$cart.cartCount.tax|appc_tax}>&nbsp;(<{$cart.cartCount.sea_region|appc_region}>)</td> 
					  </tr>
                  	</thead>
                    <tbody>
                      <tr>
                        <td>商品</td>
                        <td>标题 </td>		
                        <td><div class="price">总价</div></td>
                        <td>单价 </td>
                        <td>数量 </td>
						<td><span>增值税</span></td>
						<!--<td><span>消费税</span></td>-->
                        <td class="td-last">库存</td>
                      </tr>
                      <!--遍历所有商品 start-->
                      <{foreach from=$cart.object item=goods name=checkoutItemList}>
                      <{if $goods.obj_type=='item'}>
					  <input type="hidden" id="select_region<{$shop_id}>" value="<{$goods.sea_region}>">
					  <input type="hidden" id="select_tax<{$shop_id}>" value="<{$goods.tax}>">
                      <tr>
                        <td >
                          <div class="table-goods-pic"><a href="<{url action=topc_ctl_item@index item_id=$goods.item_id}>">
                              <{if $goods.image_default_id}>
                              <img width="64" height="64" src="<{$goods.image_default_id|storager:t}>"></a></div>
                              <{else}>
                              <img width="64" height="64" src="<{$defaultImageId.T.default_image}>">
                              <{/if}>
                        </td>
                        <td>
                          <a href="<{url action=topc_ctl_item@index item_id=$goods.item_id}>">
                            <{if $goods.activityDetail}><span class="item-describe-tag">[<{$goods.activityDetail.activity_info.activity_tag}>]</span><{/if}><{$goods.title}> </br><{$goods.spec_info}>
                          </a>
                        </td>
						<input type='hidden' name="tax_rate[]" value="<{$goods.tax_rate}>"/>
						<input type='hidden' name="reg_rate[]" value="<{$goods.reg_rate}>"/>
						<input type='hidden' name="price[]" value="<{$goods.price.price}>"/>
						<input type='hidden' name="quantity[]" value="<{$goods.quantity}>"/>
                        <td>
                          <div class="price"><{$goods.price.price+$goods.price.tax_rate_price+$goods.price.reg_rate_price|cur}></div>
                        </td>
                        <td>
                          ×<{$goods.price.price|cur}>
                        </td>
                        <td>
                          ×<{$goods.quantity}>
                        </td>
						 <td>
						 <span  data-name="post_fee_tax_rate_price[]"><{$goods.price.tax_rate_price|cur}></span>
                        </td>
						<!-- <td>
						 <span  data-name="post_fee_reg_rate_price[]"><{$goods.price.reg_rate_price|cur}></span>
                        </td>-->
                        <td class="td-last">
                          <{if $goods.store >0}>
                          有货
                          <{else}>
                          缺货
                          <{/if}>
                        </td>
                      </tr>
                      <{/if}>
                      <{if $goods.obj_type=='package'}>
                      <tr>
                        <td colspan="2">
                          <span class="item-describe-tag">组合促销</span>
                          <a href="<{url action=topc_ctl_item@index item_id=$goods.item_id}>">
                            <{if $goods.activityDetail}><span class="item-describe-tag">[<{$goods.activityDetail.activity_info.activity_tag}>]</span><{/if}><{$goods.title}> </br><{$goods.spec_info}>
                          </a>
                        </td>
                        <td>
                          <div class="price"><{$goods.price.price|cur}></div>
                        </td>
                        <td>
                          ×<{$goods.quantity}>
                        </td>
                        <td class="td-last">
                          <{if $goods.store >0}>
                          有货
                          <{else}>
                          缺货
                          <{/if}>
                        </td>
                      </tr>
                        <!-- 组合促销的商品-start -->
                        <{foreach from=$goods.skuList item=skuList}>
                        <tr>
                          <td>
                          </td>
                          <td>
                            <a href="<{url action=topc_ctl_item@index item_id=$skuList.item_id}>">
                              <{$skuList.title}> </br><{$skuList.spec_info}>
                            </a>
                          </td>
                          <td>
                            <div class="price"><{$skuList.price.price|cur}>&nbsp;(<del><{$skuList.price.old_price|cur}></del>)</div>
                          </td>
                          <td>
                          </td>
                          <td class="td-last">
                          </td>
                        </tr>
                        <{/foreach}>
                      <{/if}>
                      <{/foreach}>
					  <!--遍历所有商品 END-->
                      <tr>
                      	<td colspan="7" class="tr-coupon-info" style="padding: 0px;">
                      		 <!-- 优惠券 -->
								            <div class="order-confirm-item coupon-item">
								              <div class="order-confirm-item-bd" style="padding：0px;">
								               <!-- 未选择优惠券条件判断开始 -->
                               <div class="coupon-choose" data-shopid="<{$shop_id}>">
								                  <i class="icon-add"></i>
								                  使用优惠券
								                </div>
								                <!-- 未选择优惠券条件判断结束 -->
																<!-- 已选择优惠券条件判断开始 -->
			                          <div class="coupon-checked" style="display:none;">
			                            <span class="checked-value"></span>
			                            <input type="hidden" class="checked-coupon-id" value>
			                            <button type="button" class="btn btn-cancel btn-sm coupon-change" data-shopid="<{$shop_id}>"><span><span>修改</span></span></button>
			                          </div>
			                          <!-- 已选择优惠券条件判断结束 -->

								              </div>
								            </div>
							          		<!-- 订单备注 -->
							              <div class="order-confirm-item">
							                <div class="order-confirm-item-bd" style="padding: 0px;">订单备注
							                  <input class="x-input col-8" name="mark[<{$shop_id}>]" maxlength="85" id="" placeholder="选填：本次交易的补充说明（所填内容建议已经和商家达成一致意见，85字以内）">
							                  <span><b class="mark_count">0</b>/85</span>
							                </div>
							              </div>
                      	</td>
                      </tr>

                      <tr>
                        <td colspan="6" class="tr-last" style="font-size: 12px;">总重量：<span class="price"><{$cart.cartCount.total_weight}>kg </span>消费税：<span class="price" data-name="xiaofei[<{$cart.shop_id}>]"><{$cart.cartCount.tax_rate_price|cur}></span>
						增值税：<span class="price" data-name="zengzhi[<{$cart.shop_id}>]">
						<{$cart.cartCount.reg_rate_price|cur}>
						</span>
						店铺总计：<span class="price" data-name="zongji[<{$cart.shop_id}>]">
					
					</span>
						（含运费：<span class="price" data-name="price[<{$cart.shop_id}>]">￥0</span>）<input type="hidden" name="zongji[<{$cart.shop_id}>]" value="<{$cart.cartCount.total_fee}>">
						<input type="hidden" name="jinkou[<{$cart.shop_id}>]" value="<{$cart.cartCount.tax_price}>">
						<input type="hidden" name="tax[<{$cart.shop_id}>]" value="<{$cart.cartCount.tax}>">
						</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
          <{/foreach}>

          <!-- 发票信息 -->
		  <{if $cart.cartCount.tax==1}>
          <div class="order-confirm-item order-verify-invoice">
            <{include file="topc/checkout/invoice.html"}>
          </div>
       <{/if}>
 <!-- 购物须知 -->
					<div class="order-confirm-item order-verify-paytype">
						<div  style="height: 10px;line-height: 10px;padding: 0 10px;">
        <input type="checkbox" class="x-checkbox" name="license" id="for_license" data-validate="onerequired" data-caution="<{t}>请选择同意<{/t}>">
        <label for="for_license">我已阅读并同意<a href="javascript:void(0);" id='license';class="action-open-dialog">《跨境电商商品购物须知》</a></label>

						</div>
					</div>
          <!-- 使用会员积分 -->
          <{if $if_open_point_deduction}>
          <div class="order-confirm-item order-verify-invoice">
            <div class="order-confirm-item-bd" style="height: 10px;line-height: 10px;padding: 0 10px;">
              <!-- 当前积分不可用时，需要在use-point 后面加上 disabled 样式 -->
              <div class="item-border use-point">
                <span class="choose-point"><input type="checkbox" id="chk_point" /> <label for="chk_point">使用会员积分</label>
                <span class="deduct-content"><i></i>当前积分不可用</span>
                </span>
               <span class="point-info" style="display:none;">
                  <span class="point-number"><input type="text" name="use_points" value="" placeholder="0" onkeyup='this.value=this.value.replace(/\D/gi,"")' />&nbsp;点</span>
                  <span class="deduct-point"></span>
                  <div class="left-point">可用<em>0</em>点积分</div>
               </span>
              </div>
            </div>
          </div>
          <{/if}>

          <!-- 订单总计 -->
          <div class="order-confirm-item verify-total-info">
            <{include file="topc/checkout/total.html"}>
          </div>
          <div class="cart-table cart-table-ft verify-table">
						<div class="cart-table-btm">
							<div class="cart-row item-border">
								<div class="cart-col cart-col-right">
									<div class="row">
										<button type="submit" class="btn btn-import btn-lg" id="confirm_submit"><span><span>提交订单</span></span></button>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- 选择满减弹出层开始 -->
      <div id="coupon-dialog" style="display:none">
      </div>
      <div id="coupon-dialog-bg" style="display:none"></div>
      <!-- 选择满减弹出层结束 -->
		</form>
	</div>
</div>

<script>
//定义checkout步骤类
var CheckOut = function(){
    var self = this;
    var init = function(){
        $('#main').on('click','.step1-close',function(e){
            e.preventDefault();
            self.step1.close();
        }).on('click','.step1-open',function(e){
            e.preventDefault();
            self.step1.open();
        }).on('click','.step3-open',function(e){
            e.preventDefault();
            self.step3.open();
        }).on('click','.step3-close',function(e){
            e.preventDefault();
            self.step3.close()
        }).on('click','input[name="invoice[need_invoice]"]',function(){
            var el = $(this);
            if(el.val() == "1"){
                $('.invoice-info').show();
            }else{
                $('.invoice-info').hide();
            }
        })
        // .on('click', '.addr-more', function() {
        // 	var icon_chevron = $(this).find('.icon');
        // 	if(icon_chevron.attr('data-value') == '0') {
        // 		icon_chevron.addClass('icon-chevron-up');
        // 		icon_chevron.removeClass('icon-chevron-down');
        // 		icon_chevron.attr('data-icon', '\\2847');
        // 		icon_chevron.attr('data-value', '1');
        // 		$('.addr-list').css('height', 'auto');
        // 		$(this).find('span[name="txt-all"]').text('收起');
        // 	} else {
        // 		icon_chevron.removeClass('icon-chevron-up');
        // 		icon_chevron.addClass('icon-chevron-down');
        // 		icon_chevron.attr('data-icon', '\\2844');
        // 		icon_chevron.attr('data-value', '0');
        // 		$('.addr-list').css('height', '186px');
        // 		$(this).find('span[name="txt-all"]').text('显示所有');
        // 	}
        // });
        //  showAddrMore();
    };

    self.step3 = {
        el:$('.step3'),
        update:$('.step3-update'),
        open:function(){
            this.el.show();
            this.update.hide();
            this.state = 'open';
        },
        close:function(){
          var html = this.el.find('.invoice-type:checked').parent('label').find('span').text()+'('+this.el.find('select option:selected').text()+') 发票抬头'+$('input[name="invoice[invoice_content]"]').val();
          this.el.hide();
          this.update.html(html);
          this.update.show();
          this.state = 'close';
        },
        state:'open'
    };
    init();
};

//实例化订单确认页
CheckOut = new CheckOut();
$('#main').on('click', 'input[name="paytype"]', function() {
	var el = $(this);
	if(el.val() == "3") {
		$('.order-verify-gooditem').each(function(i) {
			$('li[name="hdfk_' + (i+1) + '"]').show();
		});
	}else {
		$('li[name^="hdfk_').hide();
	}
}).on('click', '.takegoods-set', function() {
  var areaid;
  var ele = $(this);
  var shop_id = $(this).attr('data-shopid');
  $('input[name="addr"]').each(function(){
    if($(this).prop('checked')){
      areaid = $(this).next('label').attr('data-addr-id');
    }
  });
  if(!areaid){
    alert('请先选择收货地址！');
    return false;
  }
  var ziti_id = $('input[name="ziti[' + shop_id + '][ziti_id]"]').val();
  var dialog = new Dialog('<{url action=topc_ctl_cart@getZitiList}>', {
    width: 780,
    title: '选择自提地点',
    modal:true,
    async: 'ajax',
    component: {
      container: 'dialog takegoods-dialog'
    },
    asyncOptions: {
      type: 'post',
      data:{
        addr_id:areaid,
        ziti_id: ziti_id
      },
      callback: function(xhr) {
      	$('.item-addr').on('click', function(e) {
	       	$(this).find('.takegoods-addr').addClass('active');
	       	$(this).siblings().find('.takegoods-addr').removeClass('active');
	     	});
	     	$('.ziti-save').on('click', function(e) {
	     		var flag = false;
	     		$('.takegoods-addr').each(function() {
	     			if($(this).hasClass('active')){
	     				flag = true;
	     			}
	     		});
	     		if(!flag) {
	     			alert('请选择自取地点！');
            return false;
	     		} else {
	     			var data_id = $('.active').parent().attr('data-id');
	     			var data_addr = $('.active').parent().attr('data-addr');
	     			ele.parent().find('span[data-name="ziti-addr[' + shop_id + ']"]').html(data_addr);
	     			ele.parent().find('input[name="ziti[' + shop_id + '][ziti_id]"]').val(data_id);
	     			dialog.hide();
            total();
	     		}
	     	});
      }
    }
  });
}).on('change', 'input[name^="distribution"]', function() {
  var shop_id = $(this).attr('data-shopid');
  var distributionType = $(this).val();
  if(distributionType == "1") { //快递配送
    expressDefault($('select[name="shipping['+shop_id+'][template_id]"]'));
  }else if(distributionType == "0") { //上门自取
    ziTiDefault(shop_id);
  }
  total();
});
//配送方式选择
chooseDistributionType("-1");
function chooseDistributionType(areaId) {
  $('input[data-name^="distribution["]').each(function() {
    getDistributionType($(this), areaId);
  });
}

//配送类型选择
$('.left-infos input[name^="distribution"]').on('click', function() {
		var id = $(this).attr('data-shopid');
		if($(this).val() == '1') {
			$('li[name="kdps_' + id + '"]').show();
			$('li[name="smzq_' + id + '"]').hide();
		} else {
			$('li[name="kdps_' + id + '"]').hide();
			$('li[name="smzq_' + id + '"]').show();
		}
	});
//配送方式加载
function getDistributionType(ele, areaId) {
	var shop_id = ele.attr('data-shopid');
  var weight = ele.attr('data-weight');
  var areaid;
  if(areaId == '-1') {
    $('input[name="addr"]').each(function(){
      if($(this).prop('checked')){
        areaid = $(this).next('label').attr('data-region-id');
      }
    });
  } else {
    areaid = areaId;
  }
  if(typeof(areaid) == 'undefined') return;
var select_tax = $('#select_tax'+shop_id).val(); //获取业务模式
var select_region = $('#select_region'+shop_id).val();//获取业务区域
	$.ajax({
		url: '<{url action=topc_ctl_cart@getDtyList}>',
		type: 'post',
		datatype: 'json',
		data: {
	 shop_id:shop_id,
      areaId:areaid,
	  select_tax:select_tax,
	  select_region:select_region,
      weight:weight
		},
		success: function(res) {
			var selStr = '<option value="-1" data-post-fee="0" selected>--请选择快递公司--</option>';
			$(res).each(function(i) {
				selStr += '<option value="' + res[i].template_id + '" data-post-fee="' + res[i].post_fee + '">' + res[i].name +'(' + priceControl.format(res[i].post_fee) + ')</option>';
			});

			$('select[name="shipping[' + shop_id + '][template_id]"]').html(selStr);
		}
	});
}
$('#button_usercard').click(function(){
var buycard =$('#buycard').val();
if(buycard==''){
Message.error('身份证不能为空');
return false;
}

  var data='buycard='+buycard
  $.post('<{url action=topc_ctl_cart@buycard}>',data,function(rs){
if(rs==1){
Message.error('身份证格式错误');
}
if(rs==2){
$('#buycard_val').val(buycard);
Message.error('保存成功');
}
if(rs==3){
Message.error('保存失败');
}
});
})
//选择配送方式改变相应快递运费
$('select[name^="shipping"]').change(function() {
  expressDefault($(this));
  total();
  if($('#chk_point').is(':checked')){
    $('#chk_point').attr('checked',false);
    $('#chk_point').change();
  }
}).change();

function expressDefault(ele) {
  var post_fee = ele.find('option:selected').attr('data-post-fee');
  var total_price = $('input[name^="zongji[' + ele.attr('data-shopid') + ']"]').val();

// <span  data-name="post_fee_tax_rate_price[]"><{$goods.price.tax_rate_price|cur}></span>
          
//	 <span  data-name="post_fee_reg_rate_price[]"><{$goods.price.reg_rate_price|cur}></span>
var post_fee_tax_rate_price = $('span[data-name^="post_fee_tax_rate_price[]"]');
var post_fee_reg_rate_price = $('span[data-name^="post_fee_reg_rate_price[]"]');
  var tax = $('input[name^="tax[' + ele.attr('data-shopid') + ']"]').val();
var tax_rate = $('input[name="tax_rate[]"]');  //消费税
var reg_rate = $('input[name="reg_rate[]"]');  //数量
var price = $('input[name="price[]"]');            //价格
var quantity = $('input[name="quantity[]"]');  //数量
var rate=0;
var reg=0;
  if(post_fee) {
//重新计算消费税，和增值税。
if(tax>1){
 for( var i = 0; i < tax_rate.length; i++ ) {
	var  prices =price.eq(i).val();
	var  quantityes =quantity.eq(i).val();
	var  tax_rates =tax_rate.eq(i).val();  //增值税tax_rates
	var  reg_rates =reg_rate.eq(i).val(); //消费税reg_rates

var item_rate=(((prices*quantityes)+(prices*quantityes)/total_price*post_fee)/(1-reg_rates))*reg_rates*0.7;  //消费税
post_fee_tax_rate_price.eq(i).text(priceControl.format(item_rate));  //消费税
rate = Number(rate) + Number(item_rate);
var item_reg=(((prices*quantityes)+(prices*quantityes)/total_price*post_fee)+item_rate)*tax_rates*0.7;  //增值税
post_fee_reg_rate_price.eq(i).text(priceControl.format(item_reg)); //增值税
reg = Number(reg) + Number(item_reg);
 }
total_price = Number(total_price) + Number(post_fee)+Number(rate)+Number(reg);
}else{
  total_price = Number(total_price) + Number(post_fee);
}
  }else{//运费不存在的时候
if(tax>1){
 for( var i = 0; i < tax_rate.length; i++ ) {
	var  prices =price.eq(i).val();
	var  quantityes =quantity.eq(i).val();
	var  tax_rates =tax_rate.eq(i).val();  //消费税 2016/5/2 雷成德
	var  reg_rates =reg_rate.eq(i).val(); //  增值税 2016/5/2 雷成德

var item_rate=((prices*quantityes)/(1-reg_rates))*reg_rates*0.7;  //消费税 2016/5/2 雷成德
rate = Number(rate) + Number(item_rate);
var item_reg=((prices*quantityes)+item_rate)*tax_rates*0.7;  //增值税 2016/5/2 雷成德
reg = Number(reg) + Number(item_reg);
 }
total_price = Number(total_price) +Number(rate)+Number(reg);
}else{
  total_price = Number(total_price);
}
  }

  $('span[data-name^="xiaofei[' + ele.attr('data-shopid') + ']"]').text(priceControl.format(rate));
  $('span[data-name^="zengzhi[' + ele.attr('data-shopid') + ']"]').text(priceControl.format(reg));
  $('span[data-name^="zongji[' + ele.attr('data-shopid') + ']"]').text(priceControl.format(total_price));
  $('span[data-name^="price[' + ele.attr('data-shopid') + ']"]').text('￥' + ele.find('option:selected') ? priceControl.format(post_fee) : '￥0.00');
}

//选择自提方式没有快递费
function ziTiDefault(shioId) {
  var total_price = Number($('input[name^="zongji[' + shioId + ']"]').val());
  $('span[data-name^="zongji[' + shioId + ']"]').text(priceControl.format(total_price));
  $('span[data-name^="price[' + shioId + ']"]').text('￥0.00');
}

// 备注的到计数
$('input[name^="mark"]').on('input',function(){
	var cur = $(this).next().find('.mark_count'), max = 85;
	if(this.value.length > max) {
		this.value = this.value.substr(0, max);
	}
	cur.text(this.value.length);
});

//修改、添加地址
$('#main').on('click', '.action-edit-address', function (e) {
	var el = $(this),
	dataEl = el.parent().find('label');
	$.dialog.ajax('<{url action=topc_ctl_cart@addr_dialog}>', {
		width: 500,
		title:'收货地址',
    modal:true,
		asyncOptions:{
			type: 'post',
			callback: function(xhr) {
				new AreaWidget({
					dataUrl:"<{$env.base_url}>/app/ectools/statics/scripts/region.json",
					select:this.body.find('.area-select'),
					initData:dataEl.data('region-id')
				});
	
				this.body.find('form').attr('action','<{url action=topc_ctl_cart@saveAddress}>');
				this.body.find('input[name=addr]').val(dataEl.data('addr'));
				this.body.find('input[name=zip]').val(dataEl.data('zip'));
				this.body.find('input[name=name]').val(dataEl.data('name'));
				this.body.find('input[name=card_id]').val(dataEl.data('card_id'));
				this.body.find('input[name=mobile]').val(dataEl.data('mobile'));
				this.body.find('input[name=addr_id]').val(dataEl.data('addrId'));
				this.body.find('form').data('validateConfig', {
					tips: {
									form: 'block'
								}
				})
				.find('[type=submit]').data('ajaxConfig', {
					update: '#address_edit .step1',
					callback: $.proxy(function(rs) {
            if(rs.success){
              Message.success('保存成功');
              this.hide();
            }
            var areaid;
            $(rs.responseText).find('input[name="addr"]').each(function(){
              if($(this).prop('checked')){
                areaid = $(this).next('label').attr('data-region-id');
              }
            });
            chooseDistributionType(areaid);
            total();
					}, this)
				});
			}
		}
	});
});

//选取地址改变事件
$('#checkout_address').on('change', 'input[name="addr"]', function() {
  chooseDistributionType("-1");
	total();
});

$('#for_license').click(function(){
//	alert($('#for_license').val());
if($('#for_license').val()=='on'){
$('#for_license').val('checked');
}else{
$('#for_license').val('on');
};
})

$('#license').click(function(){
 var dialog2 = new Dialog('<{url action=topc_ctl_cart@shoppingnotes}>', {
    width: 780,
    title: '购物须知',
    modal:true,
    async: 'ajax',
    component: {
      container: 'dialog takegoods-dialog'
    },
    asyncOptions: {
      type: 'post',
    }
  });
})
// 价格更新
function total(){
  var form_action = '<{url action=topc_ctl_cart@total}>';
  var fastbuyMode = '<{$mode}>';
  var addr_id = $('input[name="addr"]:checked').val();
  // 处理配送方式
	var shipping = $('select[name^="shipping"]');
  var dlytmpl = '';
  $.each(shipping,function(i,n){
    if(n.name && $(this).val()){
      dlytmpl += '&'+n.name+'='+$(this).val();
    }else
    	dlytmpl += '&'+n.name+'= -1';
  });
  //自提
  var ziti = $('span[data-name^="ziti-addr"]');
  var zitiAddr = '';
  $.each(ziti, function(i, n) {
  	var ziti_value = $(this).parent().parent().find('input[name^="distribution"]').val();
  	if($(this).html() != '请选择自取地点')
  		zitiAddr += '&' + $(this).html() + '=' + ziti_value;
  });
  //支付方式
  var payment_type = $('input[name="payment_type"]:checked').val();
  //配送类型
  var distribution = $('input[name^="distribution"]:checked');

  var disb = '';
  $.each(distribution,function(i,n){
    if(n.name && $(this).val()){
      disb += '&'+n.name+'='+$(this).val();
    }
  })
  var data='addr_id='+addr_id+'&payment_type='+payment_type+dlytmpl+disb+'&mode='+fastbuyMode+'&checkout=1';
  $.post(form_action,data,function(rs){
      var post_fee = 0;//总运费
      var weight = 0; //总重量
      var total_fee = 0;//商品总金额
      var reduction = 0;//减免
	  var totalTax_rate_price = 0;//消费税  2016/3/23tax_price雷成德
	  var totalTeg_rate_price = 0;//增值税  2016/3/23tax_price雷成德
	  var tax = 0;//税  2016/3/23tax_price雷成德
	  var lastshop_id = 0;//只要最后一个店铺id 2016/3/23tax_price雷成德
      rs.shop && $.each(rs.shop, function(k, v) {
          post_fee += Number(v.post_fee);
          weight += v.totalWeight;
          total_fee += v.total_fee;
          reduction += v.discount_fee;
		  totalTax_rate_price += v.tax_rate_price;  //2016/3/23 lcdshop_id
		  totalTeg_rate_price += v.reg_rate_price;  //2016/3/23 lcd
		  lastshop_id = v.shop_id;  //2016/3/23 lcd
		  if(v.tax>0){
		  tax = v.tax  //业务模式，如果订单确认页面是多个店铺，那么肯定是完税模式
		  }
      })

    var   allPayment_data= Number(totalTax_rate_price)+Number(totalTeg_rate_price)+Number(rs.allPayment);
	 $('#total_fee').html(priceControl.format(allPayment_data)); //总价lcd 2016/3/23
      totalPrice = Number($("#total_fee").text().substr(1));
      $('.shop-weight').html(weight+'&nbsp;kg');
      $('.shop-total_fee').html(priceControl.format(total_fee));
      $('.shop-post_fee').html(priceControl.format(post_fee));
      $('.shop-reduction').html('-'+priceControl.format(reduction));
	  $('.shop-totalTax_rate_price').html(priceControl.format(totalTax_rate_price));  //tax_price雷成德2016/3/23
	  $('.shop-totalTeg_rate_price').html(priceControl.format(totalTeg_rate_price));  //tax_price雷成德2016/3/23
      shopReduction = Number($(".shop-reduction").text().substr(2));
      shopPostTee = Number($(".shop-post_fee").text().substr(1)); 
	 if(tax>1){
	var   zongji =      $('span[data-name^="zongji[' +lastshop_id + ']"]').text();
		var   zengzhi =      $('span[data-name^="zengzhi[' +lastshop_id + ']"]').text();
		var   xiaofei =      $('span[data-name^="xiaofei[' +lastshop_id + ']"]').text();
   $('#total_fee').html(priceControl.format(zongji)); //总价lcd 2016/3/23
      $('.shop-totalTax_rate_price').html(priceControl.format(xiaofei));  //tax_price雷成德2016/3/23
	 $('.shop-totalTeg_rate_price').html(priceControl.format(zengzhi));  //tax_price雷成德2016/3/23
 }


  });
  return false;
}

// 临时提交订单js
$('#confirm_submit').click(function(){
  if($('input[name="addr"]:checked').val() == '-1'){
    Message.error('请先选择收货信息');return false;
  }
  var form_action = '<{url action=topc_ctl_trade@create}>';
  var fastbuyMode = '<{$mode}>';
  var addr_id = $('input[name="addr"]:checked').val();
  var card_id =$('#card_id').val();
	var shipping = $('select[name^="shipping"]');

  //订单备注
  var makr = $('input[name^="mark"]');

  //发票信息
  var invoice = $.param( $('input[name^="invoice"]').serializeArray() );
  var invoice_title = $('select[name="invoice[invoice_title]"]').val();

  //自提信息
  var ziti = $('input[name^="ziti"]');

  //使用积分
  var use_points = $('input[name="use_points"]').val() ? $('input[name="use_points"]').val() : 0;

  //配送类型
  var distribution = $('input[name^="distribution"]:checked');

  var disb = '';
  $.each(distribution,function(i,n){
    if(n.name && $(this).val()){
      disb += '&'+n.name+'='+$(this).val();
    }
  })

  var dlytmpl = '';
  $.each(shipping,function(i,n){
    if(n.name && $(this).val()){
      dlytmpl += '&'+n.name+'='+$(this).val();
    }
  })

  var zitiAddr = '';
  $.each(ziti,function(i,n){
    if(n.name && $(this).val()){
      zitiAddr += '&'+n.name+'='+$(this).val();
    }
  })

  var trade_memo = '';
  $.each(makr,function(i,n){
    if(n.name && $(this).val()){
      trade_memo += '&'+n.name+'='+$(this).val();
    }
  })
var  buycard_val =$('#buycard_val').val();
var license          =$('#for_license').val();
  if(!addr_id){ alert("请选择收货地址！");location.href="#";return false;}
 if(!card_id){ alert("请选择收货人的身份证！");location.href="#";return false;}  //雷成德 2016/4/29 填收货人身份证
 if(!buycard_val){ alert("请选择购买人的身份证！");location.href="#";return false;}  //雷成德 2016/4/29 填收货人身份证
   if(license=='on'){ alert("请阅读并同意购物须知！");location.href="#";return false;}
  var payment_type = $('input[name="payment_type"]:checked').val();
  var data = 'addr_id='+addr_id+'&payment_type='+payment_type+disb+dlytmpl+zitiAddr+'&use_points='+use_points+'&mode='+fastbuyMode+'&md5_cart_info=<{$md5_cart_info}>';
  var data = data+trade_memo+'&'+invoice+'&invoice[invoice_title]='+invoice_title+'&invoice='+invoice_title;
  $.post(form_action,data,function(rs){
    // rs = $.parseJSON(rs);
    if(rs.success){
      Message.success(rs.message);
      location.href = rs.redirect;
    }else{
      Message.error(rs.message);
    }
  })
  return false;
});

function showCouponDialog(cid, selectId){
  $.post('<{url action=topc_ctl_cart@getCoupons}>','shop_id=' + cid,function(rs){
      $('#coupon-dialog').html(rs).show();
      $('#coupon-dialog-bg').show();
      var boxHeight = $('#coupon-dialog').height();
      $('#coupon-dialog').css('margin-top',-boxHeight/2);
      var radiolist = $('#coupon-dialog').find('input[type="radio"]');
      if(selectId){
        $(radiolist).each(function(){
          if($(this).val()==selectId){
            $(this).prop('checked',true);
          }
        })
      }
  });
};

function hideCouponDialog(){
  $('#coupon-dialog').hide();
  $('#coupon-dialog-bg').hide();
};

var resultDom, valueDom, that, thet, shopId;

$('.table-checkout').on('click','.coupon-choose',function() {
  that = $(this);
  shopId = that.attr('data-shopid');
  showCouponDialog(shopId);
  resultDom = that.parent().find('.coupon-checked');
  valueDom = that.parent().find('.checked-value');
}).on('click','.coupon-change',function() {
  var select_input = $(this).parent().find('.checked-coupon-id');
  var select_id = $(select_input).val();
  shopId = $(this).attr('data-shopid');
  showCouponDialog(shopId, select_id);
  that = $(this).parent();
  valueDom = that.find('.checked-value');
  resultDom = that.parent().find('.coupon-choose');
});

$('#coupon-dialog').on('click','#check_coupon',function(e) {
  hideCouponDialog();
  var couponInput = $(this).parent().parent().find('input[type="radio"]:checked');
  var couponCode = couponInput.val();
  var fastbuyMode = '<{$mode}>';
  var data = 'mode='+fastbuyMode+'&shop_id='+ shopId +'&coupon_code='+ couponCode;

  if(couponCode!='-1') {
    $.post('<{url action=topc_ctl_cart@useCoupon}>',data,function(rs){
      if(rs.error==true){
        Message(rs.message);
        return;
      }else{
        if(that.hasClass('coupon-choose')){
          resultDom.show();
          valueDom.text(couponInput.attr('data-coupon-desc'));
          // 赋值优惠券号码
          that.hide();
          resultDom.find('.checked-coupon-id').val(couponCode);
          total();
        }else{
          resultDom.hide();
          valueDom.text(couponInput.attr('data-coupon-desc'));
          // 赋值优惠券号码
          that.show();
          resultDom.parent().find('.checked-coupon-id').val(couponCode);
          total();
          if($('#chk_point').is(':checked')){
            $('#chk_point').attr('checked',false);
            $('#chk_point').change();
          }
        }
      }
    });
  }else{
    // 赋值优惠券号码为空
    $.post('<{url action=topc_ctl_cart@cancelCoupon}>',data,function(rs){
      if(rs.error==true){
        Message(rs.message);
        return;
      }else{
        if(that.hasClass('coupon-choose')){
          resultDom.parent().find('.checked-coupon-id').val('');
          resultDom.hide();
          that.show();
          total();
        }else{
          resultDom.parent().find('.checked-coupon-id').val('');
          resultDom.show();
          that.hide();
          total();
        }
      }
    });
  }
});

$('#coupon-dialog').on('click','.btn-cancel',function(e) {
  hideCouponDialog();
});

function placeholderSupport() {
    return 'placeholder' in document.createElement('input');
}
if(!placeholderSupport()){   // 判断浏览器是否支持 placeholder
    $('[placeholder]').focus(function() {
        var input = $(this);
        console.log(input.val());
        if (input.val() == input.attr('placeholder')) {
            input.val('');
            input.removeClass('placeholder');
        }
    }).blur(function() {
        var input = $(this);
        if (input.val() == '' || input.val() == input.attr('placeholder')) {
            input.addClass('placeholder');
            input.val(input.attr('placeholder'));
        }
    }).blur();
}

//积分使用
var propertion = 0;
var canUserPoints = 0;
var totalPrice = Number($("#total_fee").text().substr(1));//总金额
var shopReduction = Number($(".shop-reduction").text().substr(2));//减免
var shopPostTee = Number($(".shop-post_fee").text().substr(1));//总运费
$('#chk_point').on('change', function() {
  $('.left-point em').text('');
  $('input[name="use_points"]').val('');
  $('.deduct-point').text('');
  if($(this).is(':checked')) {
    $.post('<{url action=topc_ctl_member_point@ajaxGetUserPoint}>',{'total_price':totalPrice,'post_fee':shopPostTee},function(rs) {
      if(rs) {
        if(rs.open_point_deduction == "1" && rs.points !=0 && rs.point_deduction_max !=0 ){ //积分可用
          propertion = rs.point_deduction_rate;//换算比率
          var maxpoints = rs.point_deduction_max; //最大积分
          var points = rs.points; //总积分
          var totalPricePoints = totalPrice * propertion;
          if(maxpoints <= points) {
            canUserPoints = maxpoints
          }else {
            canUserPoints = points;
          }
          if(canUserPoints > totalPricePoints) {
            canUserPoints = totalPricePoints;
          }
          $('.left-point em').text(canUserPoints);
          $('.point-info').show();
          if($('.use-point').hasClass('disabled'))
            $('.use-point').removeClass('disabled');
        }else { //积分不可用
          $('.point-info').hide();
          if(!$('.use-point').hasClass('disabled'))
            $('.use-point').addClass('disabled');
        }
      }
    });
  }else {
    $('.point-info').hide();
    $("#total_fee").text(priceControl.format(totalPrice));
    $('.shop-reduction').html('-'+priceControl.format(shopReduction));
  }
});
$('input[name="use_points"]').on('keyup', function() {
  if(parseInt($(this).val()) > canUserPoints)
    $(this).val(canUserPoints);
  var deductionPoint = $.trim($(this).val()) ? Number(parseInt($.trim($(this).val()))/propertion).toFixed(2) : 0;
  $('.deduct-point').text("-￥" + deductionPoint);
  $("#total_fee").text(priceControl.format(totalPrice - deductionPoint));
  $('.shop-reduction').html('-'+priceControl.format(shopReduction+deductionPoint));
});

//保留两位小数并四舍五入
Number.prototype.toFixed=function(len)
{
var add = 0;
var s,temp;
var s1 = this + "";
var start = s1.indexOf(".");
if(s1.substr(start+len+1,1)>=5)add=1;
var temp = Math.pow(10,len);
s = Math.floor(this * temp) + add;
return s/temp;
}
</script>

